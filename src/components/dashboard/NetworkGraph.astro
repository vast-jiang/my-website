---
interface Props {
  id: string; // 必须传入唯一的 ID，防止图表冲突
  title?: string;
  nodes: any[];
  links: any[];
}

const { id, title = "NETWORK", nodes, links } = Astro.props;
---

<div
  class="glass-panel p-0 relative h-[450px] w-full overflow-hidden group border-t-0 md:border-t"
>
  <!-- 装饰性 HUD -->
  <div
    class="absolute top-4 left-4 z-10 flex flex-col gap-1 pointer-events-none select-none"
  >
    <div class="flex items-center gap-2 text-xs text-dos-primary font-bold">
      <span class="w-2 h-2 bg-dos-primary animate-ping"></span>
      {title}_VISUALIZER
    </div>
    <div class="text-[10px] text-dos-dim font-mono">
      NODES: {nodes.length} | LINKS: {links.length} | STATUS: ACTIVE
    </div>
  </div>

  <!-- 图表容器 (使用动态 ID) -->
  <div
    id={`echarts-${id}`}
    class="w-full h-full graph-container"
    data-nodes={JSON.stringify(nodes)}
    data-links={JSON.stringify(links)}
  >
  </div>

  <!-- 底部扫描线装饰 -->
  <div
    class="absolute bottom-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-dos-primary/50 to-transparent opacity-50"
  >
  </div>
</div>

<script>
  import * as echarts from "echarts";

  const initCharts = () => {
    // 找到所有图表容器
    const containers = document.querySelectorAll(".graph-container");

    containers.forEach((dom) => {
      const el = dom as HTMLElement;
      if (!el) return;

      // 防止重复初始化
      if (echarts.getInstanceByDom(el)) {
        echarts.dispose(el);
      }

      // 从 data 属性读取数据
      const nodes = JSON.parse(el.dataset.nodes || "[]");
      const links = JSON.parse(el.dataset.links || "[]");

      const myChart = echarts.init(el, null, { renderer: "canvas" });

      const option = {
        backgroundColor: "transparent",
        tooltip: {
          backgroundColor: "rgba(0,0,0,0.9)",
          borderColor: "#33ff00",
          textStyle: { color: "#33ff00", fontFamily: "monospace" },
          formatter: (params: any) => {
            return `> NODE: ${params.name}<br>> TYPE: ${params.data.category || "LINK"}`;
          },
        },
        series: [
          {
            type: "graph",
            layout: "force",
            data: nodes.map((n: any) => ({
              ...n,
              itemStyle: {
                color: "rgba(0,0,0,0.4)", // 节点半透明
                borderColor: n.color, // 边框颜色
                borderWidth: 2,
                shadowBlur: 10, // 霓虹光晕
                shadowColor: n.color,
              },
              label: {
                show: true,
                position: "right",
                color: n.color, // 文字颜色跟随节点
                fontSize: 11,
                fontFamily: "monospace",
                formatter: "{b}",
              },
            })),
            links: links.map((l: any) => ({
              ...l,
              lineStyle: {
                color: "rgba(51, 255, 0, 0.15)",
                width: 1,
                curveness: 0.1,
              },
            })),
            // 高级物理引擎配置
            force: {
              repulsion: 300, // 斥力大一点，避免重叠
              gravity: 0.08, // 引力
              edgeLength: 100, // 连线长度
              friction: 0.6, // 摩擦力
            },
            roam: true, // 可缩放拖拽
            draggable: true,
            zoom: 0.7, // 默认缩放
            emphasis: {
              focus: "adjacency",
              lineStyle: { width: 3, color: "#fff" },
              itemStyle: { borderColor: "#fff", shadowBlur: 20 },
            },
          },
        ],
      };

      myChart.setOption(option);

      // 响应大小变化
      window.addEventListener("resize", () => myChart.resize());
    });
  };

  document.addEventListener("astro:page-load", initCharts);
  initCharts();
</script>
