---
import WeatherWidget from "./WeatherWidget.astro";
import { FEATURES } from "../../config/site-config";

// 动态计算开启的组件数量
const activeWidgets = [
  FEATURES.clock,
  FEATURES.yearProgress,
  FEATURES.weather,
  FEATURES.ipStatus,
].filter(Boolean).length;

// 全关则不渲染
if (activeWidgets === 0) return;
---

<!-- 根据开启数量自动调整网格列数 -->
<div
  class={`grid grid-cols-1 md:grid-cols-2 lg:grid-cols-${Math.min(activeWidgets, 4)} gap-4 mb-8`}
>
  <!-- 1. 实时时钟 -->
  {
    FEATURES.clock && (
      <div class="glass-panel p-4 relative overflow-hidden group min-h-[100px] flex flex-col justify-between">
        <div class="text-xs text-dos-dim uppercase mb-1 flex justify-between">
          <span>SYS_TIME</span>
          <span class="animate-pulse text-dos-primary">● REC</span>
        </div>
        <div>
          <div
            id="clock-display"
            class="text-3xl font-bold text-white tracking-widest font-mono leading-none"
          >
            00:00:00
          </div>
          <div
            class="text-xs text-dos-primary/70 mt-1 font-mono"
            id="date-display"
          >
            SYNCING...
          </div>
        </div>
      </div>
    )
  }

  <!-- 2. 年进度条 -->
  {
    FEATURES.yearProgress && (
      <div class="glass-panel p-4 relative min-h-[100px] flex flex-col justify-between">
        <div class="flex justify-between text-xs text-dos-dim uppercase mb-2">
          <span>YEAR_PROGRESS</span>
          <span id="year-percent">0%</span>
        </div>
        <div class="w-full">
          <div class="h-4 bg-dos-dim/20 border border-dos-dim relative overflow-hidden">
            <div
              id="year-bar"
              class="h-full bg-dos-primary w-0 relative transition-all duration-1000 ease-out"
            >
              <div class="absolute inset-0 bg-[repeating-linear-gradient(45deg,transparent,transparent_2px,#000_2px,#000_4px)] opacity-20" />
            </div>
          </div>
          <div class="text-[10px] text-dos-dim mt-2 text-right font-mono">
            CYCLE: 2025-ALPHA
          </div>
        </div>
      </div>
    )
  }

  <!-- 3. 天气模块 -->
  <WeatherWidget />

  <!-- 4. 访客 IP -->
  {
    FEATURES.ipStatus && (
      <div class="glass-panel p-4 flex flex-col justify-between min-h-[100px]">
        <div class="text-xs text-dos-dim uppercase">CLIENT_IP</div>
        <div
          id="ip-display"
          class="text-lg font-bold font-mono text-dos-primary"
        >
          SCANNING...
        </div>
        <div class="flex gap-1 mt-2 text-[10px] text-dos-dim">
          <span>PORT: 443</span>
          <span class="text-dos-primary">SECURE</span>
        </div>
      </div>
    )
  }
</div>

<script>
  function setSafeText(id: string, text: string) {
    const el = document.getElementById(id);
    if (el) el.innerText = text;
  }

  function updateTime() {
    if (!document.getElementById("clock-display")) return;

    const now = new Date();
    const timeStr = now.toLocaleTimeString("en-US", { hour12: false });
    const dateStr = now.toLocaleDateString("zh-CN", {
      year: "numeric",
      month: "2-digit",
      day: "2-digit",
    });

    setSafeText("clock-display", timeStr);
    setSafeText("date-display", dateStr);

    if (document.getElementById("year-bar")) {
      const start = new Date(now.getFullYear(), 0, 0);
      const diff = now.getTime() - start.getTime();
      const oneDay = 1000 * 60 * 60 * 24;
      const day = Math.floor(diff / oneDay);
      const percent = ((day / 365) * 100).toFixed(1) + "%";

      setSafeText("year-percent", percent);
      const bar = document.getElementById("year-bar");
      if (bar) bar.style.width = percent;
    }
  }

  updateTime();
  setInterval(updateTime, 1000);

  if (document.getElementById("ip-display")) {
    fetch("https://api.ipify.org?format=json")
      .then((res) => res.json())
      .then((data) => {
        setSafeText("ip-display", String(data.ip));
      })
      .catch(() => {
        setSafeText("ip-display", "UNKNOWN");
      });
  }
</script>
