---
import { FEATURES } from "../../config/site-config";
// 如果关闭，直接返回空，不渲染任何 HTML
if (!FEATURES.weather) return;
---

<div
  class="glass-panel p-4 relative overflow-hidden group min-h-[100px] flex flex-col justify-between"
>
  <div class="flex justify-between items-start text-xs text-dos-dim mb-1">
    <span>ATMOSPHERE</span>
    <span class="animate-pulse text-dos-primary" id="weather-status"
      >SCANNING...</span
    >
  </div>

  <div class="flex items-end justify-between">
    <div>
      <div id="weather-temp" class="text-3xl font-bold text-white leading-none">
        --°C
      </div>
      <div id="weather-desc" class="text-xs text-dos-primary/80 mt-1">
        NO_DATA
      </div>
    </div>
    <div class="text-right text-[10px] text-dos-dim space-y-0.5">
      <div>HUM: <span id="weather-hum">--</span>%</div>
      <div>WIND: <span id="weather-wind">--</span>km/h</div>
    </div>
  </div>
</div>

<script>
  async function fetchWeather() {
    // 默认坐标 (常州)，无需 Key
    const lat = 31.81;
    const long = 119.97;

    try {
      const res = await fetch(
        `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${long}&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m&timezone=auto`
      );
      const data = await res.json();

      const current = data.current;
      const code = current.weather_code;

      let desc = "UNKNOWN";
      if (code === 0) desc = "CLEAR_SKY";
      else if (code >= 1 && code <= 3) desc = "PARTLY_CLOUDY";
      else if (code >= 45 && code <= 48) desc = "FOG_DETECTED";
      else if (code >= 51 && code <= 67) desc = "RAIN_ACIDIC";
      else if (code >= 71 && code <= 77) desc = "SNOW_FALL";
      else if (code >= 95) desc = "THUNDERSTORM";

      const statusEl = document.getElementById("weather-status");
      if (statusEl) {
        statusEl.innerText = "ONLINE";
        document.getElementById("weather-temp")!.innerText =
          `${current.temperature_2m}${data.current_units.temperature_2m}`;
        document.getElementById("weather-desc")!.innerText = desc;
        document.getElementById("weather-hum")!.innerText =
          current.relative_humidity_2m;
        document.getElementById("weather-wind")!.innerText =
          current.wind_speed_10m;
      }
    } catch (e) {
      const status = document.getElementById("weather-status");
      if (status) status.innerText = "OFFLINE";
    }
  }

  // 延迟加载
  setTimeout(fetchWeather, 2000);
</script>
