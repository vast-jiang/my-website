---
import {
  MUSIC_PLAYLIST,
  GISCUS_CONFIG,
  FEATURES,
} from "../../config/site-config";
import { FILE_SYSTEM, INITIAL_PATH } from "../../config/terminal-fs";
// ÂºïÂÖ• SnakeGame Âè™ÊòØ‰∏∫‰∫ÜÁ±ªÂûãÊèêÁ§∫(Â¶ÇÊûúÊúâÁöÑËØù)ÔºåÂÆûÈôÖÈÄªËæëÂú®‰∏ãÊñπ script ‰∏≠
---

<!-- 1. ÁßªÂä®Á´ØÊäòÂè†ÊåâÈíÆ -->
<button
  id="mobile-toggle"
  class="md:hidden fixed bottom-4 right-4 z-[91] w-12 h-12 bg-black border-2 border-dos-primary rounded-full flex items-center justify-center text-dos-primary shadow-[0_0_15px_rgba(0,143,17,0.5)] active:scale-90 transition"
>
  <span class="text-2xl font-bold">‚â°</span>
</button>

<!-- 2. ÊÇ¨ÊµÆÂ∑•ÂÖ∑Ê†è -->
<div
  id="toolbar"
  class="fixed bottom-20 right-4 md:bottom-6 md:right-6 z-[90] flex flex-col gap-3 items-end font-mono transition-all duration-300 origin-bottom-right scale-0 opacity-0 md:scale-100 md:opacity-100"
>
  <div
    id="music-player"
    class="flex flex-col bg-black/90 border border-dos-dim p-3 shadow-[0_0_15px_rgba(0,143,17,0.3)] backdrop-blur-md w-56 transition-all duration-300 hover:border-dos-primary group"
  >
    <div
      class="flex justify-between items-end mb-2 border-b border-dos-dim/50 pb-1"
    >
      <div class="flex gap-0.5 items-end h-6" id="visualizer">
        <span
          class="bar w-1.5 bg-dos-primary opacity-50 h-2 transition-all duration-100"
        ></span>
        <span
          class="bar w-1.5 bg-dos-primary opacity-70 h-4 transition-all duration-150"
        ></span>
        <span
          class="bar w-1.5 bg-dos-primary opacity-90 h-3 transition-all duration-75"
        ></span>
        <span
          class="bar w-1.5 bg-dos-primary opacity-60 h-5 transition-all duration-200"
        ></span>
        <span
          class="bar w-1.5 bg-dos-primary opacity-80 h-1 transition-all duration-100"
        ></span>
      </div>
      <div
        class="text-[10px] text-dos-dim group-hover:text-dos-primary text-right leading-tight"
      >
        <span id="track-index">TRACK 01/01</span><br />
        <span id="status-text">READY</span>
      </div>
    </div>
    <div
      class="w-full overflow-hidden bg-dos-dim/10 border border-dos-dim/30 mb-3 py-1 relative"
    >
      <div
        id="song-title"
        class="whitespace-nowrap text-xs text-dos-primary font-bold pl-1"
      >
        LOADING...
      </div>
    </div>
    <div class="flex items-center justify-between gap-1">
      <button
        id="prev-btn"
        class="flex-1 border border-dos-dim text-dos-dim hover:text-dos-primary text-xs py-1 active:bg-dos-primary active:text-black transition"
        >|&lt;</button
      >
      <button
        id="play-btn"
        class="flex-[2] border border-dos-primary text-dos-primary hover:bg-dos-primary hover:text-black text-sm py-1 font-bold active:scale-95 transition"
        >‚ñ∂</button
      >
      <button
        id="next-btn"
        class="flex-1 border border-dos-dim text-dos-dim hover:text-dos-primary text-xs py-1 active:bg-dos-primary active:text-black transition"
        >&gt;|</button
      >
    </div>
  </div>

  <div class="flex gap-2">
    <button
      id="theme-btn"
      class="bg-black/80 text-dos-dim border border-dos-dim px-3 py-1.5 text-xs hover:bg-dos-primary hover:text-black transition uppercase cursor-pointer active:scale-95"
      >[ THEME ]</button
    >
    <button
      id="term-btn"
      class="bg-black/80 text-dos-primary border border-dos-primary px-3 py-1.5 text-xs hover:bg-white hover:text-black transition uppercase animate-pulse cursor-pointer active:scale-95"
      >[ TERMINAL ]</button
    >
  </div>
</div>

<!-- 3. ÂÖ®Â±ÄÁªàÁ´ØÁ™óÂè£ -->
<div
  id="global-terminal"
  class="fixed inset-0 z-[100] bg-black/80 hidden flex-col items-center justify-center backdrop-blur-sm opacity-0 transition-opacity duration-300"
>
  <div
    class="w-full max-w-3xl h-[60vh] border-2 border-dos-primary bg-black flex flex-col shadow-[0_0_50px_rgba(51,255,0,0.2)] transform scale-95 transition-transform duration-300"
    id="term-window"
  >
    <div
      class="bg-dos-primary text-black px-3 py-1 flex justify-between items-center font-bold text-sm select-none"
    >
      <span class="flex items-center gap-2">
        <span class="w-2 h-2 bg-black animate-pulse"></span>
        <span id="term-prompt-path">ROOT@SYSTEM:~</span>
      </span>
      <button
        id="close-term"
        class="hover:bg-black hover:text-dos-primary px-2 transition">X</button
      >
    </div>
    <div
      id="term-output"
      class="flex-1 p-4 overflow-y-auto font-mono text-sm space-y-1 text-dos-primary/90 scrollbar-hide"
    >
      <div>> VAST_OS Kernel v3.0.0 Loaded.</div>
      <div>> Type 'help' to see available commands.</div>
      <div>> Try 'ls' to browse files.</div>
    </div>
    <div class="p-2 border-t border-dos-dim flex items-center gap-2 bg-black">
      <span class="text-dos-primary font-bold animate-pulse">></span>
      <input
        id="term-input"
        type="text"
        class="flex-1 bg-transparent border-none outline-none text-dos-primary font-mono caret-dos-primary"
        autocomplete="off"
      />
    </div>
  </div>
</div>

<!-- 4. ËÉåÊôØÂä®ÊÄÅÁâπÊïà -->
<div class="fixed inset-0 z-0 pointer-events-none overflow-hidden select-none">
  <div
    class="absolute left-2 md:left-6 h-screen w-64 opacity-30 mix-blend-screen hidden lg:flex flex-col justify-center"
  >
    <div
      class="w-full h-[70vh] overflow-hidden relative"
      style="mask-image: linear-gradient(to bottom, transparent, black 20%, black 80%, transparent);"
    >
      <div
        id="proc-list"
        class="absolute inset-x-0 top-1/2 -translate-y-1/2 flex flex-col font-mono text-[10px] leading-relaxed text-dos-dim gap-1"
      >
      </div>
    </div>
  </div>
  <div
    class="absolute right-2 md:right-6 h-screen w-full md:w-96 flex flex-col justify-center items-end text-right opacity-10 md:opacity-30 mix-blend-screen"
  >
    <div
      class="w-full h-[80vh] overflow-hidden relative"
      style="mask-image: linear-gradient(to bottom, transparent, black 15%, black 85%, transparent);"
    >
      <div
        id="net-log"
        class="absolute right-0 top-1/2 -translate-y-1/2 flex flex-col items-end font-mono text-[9px] md:text-[10px] leading-relaxed text-dos-dim gap-1 whitespace-pre pr-2 md:pr-0"
      >
      </div>
    </div>
  </div>
</div>

<audio id="bg-music" preload="none"></audio>

<script
  define:vars={{
    playlistData: MUSIC_PLAYLIST,
    fsData: FILE_SYSTEM,
    initPath: INITIAL_PATH,
    features: FEATURES,
  }}
>
  // --- Ê∏∏ÊàèÂºïÊìé (ÂÜÖËÅî) ---
  class GameEngine {
    constructor(container, onGameOver) {
      this.grid = 20;
      this.speed = 100;
      this.snake = [];
      this.score = 0;
      this.direction = { x: 20, y: 0 };
      this.nextDirection = { x: 20, y: 0 };
      this.apple = { x: 0, y: 0 };
      this.isRunning = false;
      this.lastTime = 0;
      this.accumulator = 0;
      this.onGameOver = onGameOver;

      this.canvas = document.createElement("canvas");
      this.canvas.width = 400;
      this.canvas.height = 400;
      this.canvas.style.border = "2px solid #33ff00";
      this.canvas.style.background = "#050505";
      this.canvas.style.margin = "10px auto";
      this.canvas.style.display = "block";
      this.canvas.style.maxWidth = "100%"; // ÈÄÇÈÖçÊâãÊú∫
      container.appendChild(this.canvas);
      this.ctx = this.canvas.getContext("2d");

      this.handleKey = this.handleKey.bind(this);
      this.loop = this.loop.bind(this);
      document.addEventListener("keydown", this.handleKey);
    }

    start() {
      if (this.isRunning) return;
      // ÂàùÂßã‰ΩçÁΩÆÔºåÁïôÂá∫Á©∫Èó¥Èò≤Ê≠¢ÂºÄÂ±ÄÊíûÂ¢ô
      this.snake = [
        { x: 100, y: 100 },
        { x: 80, y: 100 },
        { x: 60, y: 100 },
      ];
      this.score = 0;
      this.direction = { x: this.grid, y: 0 };
      this.nextDirection = { x: this.grid, y: 0 };
      this.placeApple();
      this.isRunning = true;
      this.lastTime = 0;
      requestAnimationFrame(this.loop);
    }

    stop() {
      this.isRunning = false;
      document.removeEventListener("keydown", this.handleKey);
      this.canvas.remove();
    }

    handleKey(e) {
      if (
        ["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight", " "].includes(e.key)
      )
        e.preventDefault();

      // Èò≤Ê≠¢ÂèçÂêëÊéâÂ§¥ (Â¶ÇÂêëÂè≥Êó∂ÊåâÂ∑¶)
      switch (e.key) {
        case "ArrowLeft":
          if (this.direction.x === 0)
            this.nextDirection = { x: -this.grid, y: 0 };
          break;
        case "ArrowRight":
          if (this.direction.x === 0)
            this.nextDirection = { x: this.grid, y: 0 };
          break;
        case "ArrowUp":
          if (this.direction.y === 0)
            this.nextDirection = { x: 0, y: -this.grid };
          break;
        case "ArrowDown":
          if (this.direction.y === 0)
            this.nextDirection = { x: 0, y: this.grid };
          break;
      }
    }

    placeApple() {
      let valid = false;
      while (!valid) {
        this.apple.x =
          Math.floor(Math.random() * (this.canvas.width / this.grid)) *
          this.grid;
        this.apple.y =
          Math.floor(Math.random() * (this.canvas.height / this.grid)) *
          this.grid;
        // Á°Æ‰øù‰∏çÁîüÊàêÂú®ËõáË∫´‰∏ä
        valid = !this.snake.some(
          (s) => s.x === this.apple.x && s.y === this.apple.y
        );
      }
    }

    update() {
      this.direction = this.nextDirection;
      const head = {
        x: this.snake[0].x + this.direction.x,
        y: this.snake[0].y + this.direction.y,
      };

      // --- üêç ‰øÆÂ§çÁÇπÔºöÊíûÂ¢ôÊ£ÄÊµã (Game Over) ---
      if (
        head.x < 0 ||
        head.x >= this.canvas.width ||
        head.y < 0 ||
        head.y >= this.canvas.height
      ) {
        this.isRunning = false;
        this.onGameOver(this.score);
        return;
      }

      // ÊíûËá™Â∑±Ê£ÄÊµã
      for (let i = 0; i < this.snake.length; i++) {
        if (head.x === this.snake[i].x && head.y === this.snake[i].y) {
          this.isRunning = false;
          this.onGameOver(this.score);
          return;
        }
      }

      this.snake.unshift(head);

      // ÂêÉËãπÊûú
      if (head.x === this.apple.x && head.y === this.apple.y) {
        this.score += 10;
        this.placeApple();
        // ‰∏ç popÔºåËõáÂèòÈïø
      } else {
        this.snake.pop();
      }
    }

    draw() {
      this.ctx.fillStyle = "black";
      this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

      // Apple
      this.ctx.fillStyle = "#ff3300";
      this.ctx.fillRect(
        this.apple.x + 1,
        this.apple.y + 1,
        this.grid - 2,
        this.grid - 2
      );

      // Snake
      this.ctx.fillStyle = "#33ff00";
      this.snake.forEach((s, i) => {
        // ËõáÂ§¥È¢úËâ≤Áï•‰∏çÂêå
        this.ctx.fillStyle = i === 0 ? "#ccffcc" : "#33ff00";
        this.ctx.fillRect(s.x + 1, s.y + 1, this.grid - 2, this.grid - 2);
      });

      // Score
      this.ctx.fillStyle = "white";
      this.ctx.font = "14px monospace";
      this.ctx.fillText(`SCORE: ${this.score}`, 10, 20);
    }

    loop(timestamp) {
      if (!this.isRunning) return;
      if (!this.lastTime) this.lastTime = timestamp;
      const delta = timestamp - this.lastTime;
      this.lastTime = timestamp;
      this.accumulator += delta;

      while (this.accumulator >= this.speed) {
        this.update();
        this.accumulator -= this.speed;
      }
      this.draw();
      requestAnimationFrame(this.loop);
    }
  }

  // --- ÁªàÁ´ØÊ†∏ÂøÉÈÄªËæë ---
  const playlist = playlistData;
  const fileSystem = fsData;
  let currentPath = [...initPath];
  let currentGame = null;

  function getCurrentDir() {
    let current = fileSystem.root;
    for (const p of currentPath) {
      if (current.children && current.children[p]) {
        current = current.children[p];
      } else {
        return null;
      }
    }
    return current;
  }

  function getPromptPath() {
    return `ROOT@SYSTEM:/${currentPath.join("/")}`;
  }
  function updatePrompt() {
    const el = document.getElementById("term-prompt-path");
    if (el) el.innerText = getPromptPath();
  }

  function execCommand(input) {
    // üõ°Ô∏è DRM
    const _k = atob("dmFzdC1qaWFuZw==");
    const _el = document.getElementById("author-credit");
    if (!_el || !_el.href.includes(_k)) {
      logToTerm(`[SYSTEM CRITICAL ERROR]`, false);
      return;
    }

    const args = input.trim().split(/\s+/);
    const cmd = args[0].toLowerCase();
    const param = args[1];

    if (cmd === "") return;

    if (currentGame) {
      if (cmd === "exit") {
        currentGame.stop();
        currentGame = null;
        logToTerm("Game terminated.");
      } else {
        logToTerm('Game running... Type "exit" to quit.');
      }
      return;
    }

    switch (cmd) {
      case "help":
        logToTerm(`COMMANDS: ls, cd, cat, open, clear, snake, whoami, music`);
        return;
      case "clear":
        const output = document.getElementById("term-output");
        if (output) output.innerHTML = "";
        return;
      case "snake":
        if (!features.games) {
          logToTerm("Game module disabled.");
          return;
        }
        logToTerm("Starting Snake Protocol...");
        logToTerm('Controls: Arrow Keys | Exit: type "exit"');
        const gameDiv = document.createElement("div");
        document.getElementById("term-output").appendChild(gameDiv);

        currentGame = new GameEngine(gameDiv, (score) => {
          logToTerm(`>>> GAME OVER <<<`);
          logToTerm(`FINAL SCORE: ${score}`);
          logToTerm('Type "snake" to replay, or "exit" to quit.');
          currentGame.stop();
          currentGame = null;
        });
        currentGame.start();
        document.getElementById("term-input").blur();
        return;
      case "whoami":
        logToTerm(`USER: GUEST`);
        return;
      case "music":
        togglePlay();
        return;
      case "theme":
        document.getElementById("theme-btn")?.click();
        return;
    }

    const currentDir = getCurrentDir();
    if (!currentDir || currentDir.type !== "dir") return;

    switch (cmd) {
      case "ls":
      case "ll":
        const files = Object.keys(currentDir.children).map((name) => {
          const item = currentDir.children[name];
          const color =
            item.type === "dir"
              ? "text-dos-primary font-bold"
              : item.type === "exe"
                ? "text-dos-alert"
                : "text-dos-dim";
          return `<span class="${color}">${name}</span>`;
        });
        logToTerm(files.join("  "));
        return;
      case "cd":
        if (!param) currentPath = ["home", "guest"];
        else if (param === "..") {
          if (currentPath.length > 0) currentPath.pop();
        } else if (param === "/") currentPath = [];
        else {
          if (currentDir.children[param]?.type === "dir")
            currentPath.push(param);
          else logToTerm(`cd: ${param}: Not a directory`);
        }
        updatePrompt();
        return;
      case "cat":
        if (!param) {
          logToTerm("Usage: cat [file]");
          return;
        }
        const file = currentDir.children[param];
        if (file?.type === "file")
          file.content.split("\n").forEach((l) => logToTerm(l));
        else logToTerm("File not found or not text.");
        return;
      case "open":
        if (!param) {
          logToTerm("Usage: open [link]");
          return;
        }
        const link = currentDir.children[param];
        if (link?.type === "link") window.location.href = link.target;
        else logToTerm("Link not found.");
        return;
      default:
        logToTerm(`Unknown command: ${cmd}`);
    }
  }

  // --- UI & Audio ---
  const mobileToggle = document.getElementById("mobile-toggle");
  const toolbar = document.getElementById("toolbar");
  let isToolbarVisible = false;
  mobileToggle?.addEventListener("click", () => {
    isToolbarVisible = !isToolbarVisible;
    if (toolbar) {
      if (isToolbarVisible) {
        toolbar.classList.remove("scale-0", "opacity-0");
        toolbar.classList.add("scale-100", "opacity-100");
        mobileToggle.innerHTML = '<span class="text-xl font-bold">X</span>';
      } else {
        toolbar.classList.remove("scale-100", "opacity-100");
        toolbar.classList.add("scale-0", "opacity-0");
        mobileToggle.innerHTML = '<span class="text-2xl font-bold">‚â°</span>';
      }
    }
  });

  const audio = document.getElementById("bg-music");
  const playBtn = document.getElementById("play-btn");
  const nextBtn = document.getElementById("next-btn");
  const prevBtn = document.getElementById("prev-btn");
  const songTitle = document.getElementById("song-title");
  const trackIndex = document.getElementById("track-index");
  const statusText = document.getElementById("status-text");
  const visualizerBars = document.querySelectorAll("#visualizer .bar");
  let currentTrack = 0;
  let isPlaying = false;
  let visualizerInterval;

  function loadTrack(index) {
    if (!audio) return;
    if (index < 0) index = playlist.length - 1;
    if (index >= playlist.length) index = 0;
    currentTrack = index;
    audio.src = playlist[currentTrack].url;
    audio.load();
    if (songTitle) songTitle.innerText = `‚ô™ ${playlist[currentTrack].name} ‚ô™`;
    if (trackIndex)
      trackIndex.innerText = `TRACK ${String(currentTrack + 1).padStart(2, "0")}`;
  }

  function togglePlay() {
    if (!audio) return;
    if (isPlaying) {
      audio.pause();
      if (playBtn) playBtn.innerText = "‚ñ∂";
      if (statusText) statusText.innerText = "PAUSED";
      clearInterval(visualizerInterval);
    } else {
      audio
        .play()
        .then(() => {
          if (playBtn) playBtn.innerText = "II";
          if (statusText) statusText.innerText = "PLAYING";
          clearInterval(visualizerInterval);
          visualizerInterval = setInterval(() => {
            visualizerBars.forEach(
              (b) => (b.style.height = `${Math.random() * 1.5 + 0.2}rem`)
            );
          }, 150);
        })
        .catch(() => {});
    }
    isPlaying = !isPlaying;
  }

  function nextTrack() {
    loadTrack(currentTrack + 1);
    if (isPlaying) {
      isPlaying = false;
      togglePlay();
    }
  }
  function prevTrack() {
    loadTrack(currentTrack - 1);
    if (isPlaying) {
      isPlaying = false;
      togglePlay();
    }
  }

  playBtn?.addEventListener("click", togglePlay);
  nextBtn?.addEventListener("click", nextTrack);
  prevBtn?.addEventListener("click", prevTrack);
  audio?.addEventListener("ended", nextTrack);
  loadTrack(0);

  // --- Terminal UI ---
  const termOverlay = document.getElementById("global-terminal");
  const termWindow = document.getElementById("term-window");
  const termInput = document.getElementById("term-input");
  const termOutput = document.getElementById("term-output");
  let isTermOpen = false;

  function toggleTerm() {
    if (!termOverlay) return;
    isTermOpen = !isTermOpen;
    if (isTermOpen) {
      termOverlay.classList.remove("hidden", "opacity-0");
      termOverlay.classList.add("flex");
      termWindow.classList.remove("scale-95");
      termWindow.classList.add("scale-100");
      setTimeout(() => termInput?.focus(), 100);
      updatePrompt();
    } else {
      termOverlay.classList.add("opacity-0");
      termWindow.classList.remove("scale-100");
      termWindow.classList.add("scale-95");
      setTimeout(() => {
        termOverlay.classList.add("hidden");
        termOverlay.classList.remove("flex");
      }, 300);
    }
  }

  function logToTerm(text, isCmd = false) {
    if (termOutput) {
      const div = document.createElement("div");
      if (isCmd)
        div.innerHTML = `<span class="text-white opacity-50">[USER] > ${text}</span>`;
      else div.innerHTML = text;
      termOutput.appendChild(div);
      termOutput.scrollTop = termOutput.scrollHeight;
    }
  }

  document.addEventListener("keydown", (e) => {
    if ((e.ctrlKey && e.key === "k") || e.key === "`") {
      e.preventDefault();
      toggleTerm();
    }
    if (e.key === "Escape" && isTermOpen) toggleTerm();
  });
  document.getElementById("term-btn")?.addEventListener("click", toggleTerm);
  document.getElementById("close-term")?.addEventListener("click", toggleTerm);

  termInput?.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      const val = termInput.value.trim();
      logToTerm(val, true);
      termInput.value = "";
      execCommand(val);
    }
  });

  // Background FX
  const procList = document.getElementById("proc-list");
  const netLog = document.getElementById("net-log");
  const SYSTEM_CMDS = [
    "systemd",
    "kworker",
    "node",
    "astro",
    "docker",
    "python",
  ];
  const rndHex = () =>
    `0x${Math.floor(Math.random() * 65535)
      .toString(16)
      .toUpperCase()}`;

  if (procList) {
    setInterval(() => {
      const line = document.createElement("div");
      line.className = `flex gap-2 whitespace-nowrap opacity-60`;
      line.innerHTML = `<span class="w-8 text-dos-dim">${Math.floor(Math.random() * 9999)}</span><span class="w-10 text-dos-dim">${rndHex()}</span><span class="flex-1 truncate">${SYSTEM_CMDS[Math.floor(Math.random() * SYSTEM_CMDS.length)]}</span>`;
      procList.appendChild(line);
      if (procList.children.length > 25)
        procList.removeChild(procList.children[0]);
    }, 400);
  }
  if (netLog) {
    setInterval(() => {
      const line = document.createElement("div");
      line.className = `flex justify-end gap-2 w-full whitespace-nowrap opacity-60`;
      line.innerHTML = `<span>192.168.1.${Math.floor(Math.random() * 255)}</span><span class="text-dos-dim">ESTABLISHED</span>`;
      netLog.appendChild(line);
      if (netLog.children.length > 25) netLog.removeChild(netLog.children[0]);
    }, 300);
  }
</script>
