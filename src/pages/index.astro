---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import TerminalHeader from '../components/TerminalHeader.astro';
import TerminalFooter from '../components/TerminalFooter.astro';
import DynamicStatus from '../components/DynamicStatus.astro';
import SystemMonitor from '../components/SystemMonitor.astro';
import ProjectGallery from '../components/ProjectGallery.astro';

const posts = await getCollection('blog');
const sortedPosts = posts.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

// --- 配置区 ---

// 1. 社交链接
const socialLinks = [
  { name: 'GITHUB',   file: 'CODE.EXE',    url: 'https://github.com/vast-jiang', desc: '源代码仓库' },
  { name: 'BILIBILI', file: 'TV_BILI.EXE', url: 'https://b23.tv/x721wEC', desc: 'B站 频道' },
  { name: '抖音',     file: 'TIKTOK.BAT',  url: 'https://v.douyin.com/P2-kvozEmPA/', desc: '短视频' },
  { name: '视觉中国', file: 'PHOTO.JPG',   url: 'https://500px.com.cn/community/user-details/7486f8a4d4f76b956585e8113b24e2531', desc: '摄影集' },
  { name: 'STEAM',    file: 'GAME.EXE',    url: 'https://steamcommunity.com/profiles/76561199545014237/', desc: '游戏库' },
  { name: '嘉立创',   file: 'PCB.PRO',     url: 'https://oshwhub.com/ticdi/works', desc: '硬件工程' },
  { name: 'QQ邮箱',   file: 'MAIL.BAT',    url: 'mailto:16909925690@qq.com', desc: '发送邮件' },
  { name: 'GMAIL',    file: 'GMAIL.BAT',   url: 'mailto:jianghao1573@gmail.com', desc: 'Global Mail' },
];

const contacts = [
  { name: '微信', file: 'WECHAT.INI', value: 'CjCjHaoHaoHao', hint: '添加请备注' },
  { name: 'QQ',   file: 'TENCENT.MSG', value: '1690925690', hint: '在线' },
  { name: '闲鱼', file: 'MARKET.LOG',  value: '搜: Fluoxetine', hint: '交易' },
];

// 2. 技能矩阵 (修改这里来改变进度条)
const skills = [
  { name: 'FRONTEND_DEV', lv: 92, mem: '0x0A' },
  { name: 'HARDWARE_ENG', lv: 75, mem: '0x0B' },
  { name: 'PHOTOGRAPHY',  lv: 85, mem: '0x0C' },
  { name: 'UI_DESIGN',    lv: 60, mem: '0x0D' },
];
---

<BaseLayout title="COMMAND_CENTER">
  <TerminalHeader />

  <!-- 顶部日志跑马灯 -->
  <div class="mb-8 border-y border-dos-dim/30 bg-dos-dim/5 py-1 overflow-hidden relative group">
    <div class="whitespace-nowrap animate-[scan_20s_linear_infinite] text-xs font-mono text-dos-dim hover:pause flex">
      <span class="mr-8">> BOOT_SEQUENCE_INIT... OK</span>
      <span class="mr-8">> CHECKING_MEMORY_BLOCKS... 100%</span>
      <span class="mr-8">> MOUNTING_DRIVES... DONE</span>
      <span class="mr-8">> ESTABLISHING_SECURE_LINK... SUCCESS</span>
      <span class="mr-8 text-dos-primary">> SYSTEM_READY</span>
    </div>
  </div>

  <main class="space-y-16 min-h-screen pb-20">
    
    <!-- 1. 核心情报区 -->
    <section class="flex flex-col lg:flex-row gap-8">
      <!-- 左：ID 卡 -->
      <div class="w-full lg:w-1/3 glass-panel p-6 flex flex-col items-center text-center relative overflow-hidden group">
        <div class="absolute inset-0 bg-dos-primary/5 opacity-0 group-hover:opacity-100 transition duration-700 pointer-events-none"></div>
        <div class="relative z-10">
          <div class="w-40 h-40 border-2 border-dos-primary p-1 mx-auto mb-4 relative group/avatar">
             <!-- 旋转装饰圈 -->
             <div class="absolute -inset-4 border border-dos-dim/50 rounded-full animate-[spin_10s_linear_infinite] border-dashed opacity-50"></div>
             <img src="/images/avatar.png" class="w-full h-full object-cover grayscale contrast-125 hover:grayscale-0 transition duration-500" />
             <!-- 角落标签 -->
             <div class="absolute bottom-1 right-1 bg-black text-dos-primary text-[10px] px-1 font-bold">IMG_01</div>
          </div>
          <h2 class="text-2xl font-bold mb-1 tracking-widest">VAST_JIANG</h2>
          <div class="text-xs border border-dos-primary px-2 py-0.5 inline-block mb-4 text-black bg-dos-primary font-bold">
            LV.99 OPERATOR
          </div>
          <div class="w-full text-left mt-2">
            <DynamicStatus />
          </div>
        </div>
      </div>

      <!-- 右：技能矩阵 -->
      <div class="flex-1 flex flex-col justify-between">
        <div class="glass-panel p-6 mb-6 relative overflow-hidden">
          <div class="absolute top-0 right-0 p-2 text-[10px] text-dos-dim opacity-50">MEM_ALLOC: STATIC</div>
          
          <h3 class="text-lg font-bold border-b border-dos-dim mb-6 pb-2 flex justify-between items-end">
            <span class="flex items-center gap-2"><span class="w-2 h-2 bg-dos-primary animate-pulse"></span> SKILL_MATRIX</span>
            <span class="text-xs text-dos-dim animate-pulse">SYNCING...</span>
          </h3>
          
          <div class="space-y-5">
            {skills.map(skill => (
              <div class="group">
                <div class="flex justify-between text-xs mb-1 font-mono">
                  <span class="text-white group-hover:text-dos-primary transition">{skill.name}</span>
                  <div class="flex gap-4 text-dos-dim">
                    <span>ADDR:{skill.mem}</span>
                    <span class="text-dos-primary">{skill.lv}%</span>
                  </div>
                </div>
                <!-- 进度条轨道 -->
                <div class="h-3 bg-black border border-dos-dim/50 relative p-0.5">
                  <!-- 动态加载的进度条 -->
                  <div 
                    class="skill-bar h-full bg-dos-primary shadow-[0_0_10px_rgba(51,255,0,0.5)] relative" 
                    style={`width: 0%; --target-width: ${skill.lv}%`}
                  >
                    <!-- 进度条内部纹理 -->
                    <div class="absolute inset-0 bg-[linear-gradient(90deg,transparent,rgba(255,255,255,0.5),transparent)] bg-[length:200%_100%] animate-[scan_1.5s_linear_infinite]"></div>
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>

        <div class="glass-panel p-6 flex-1 flex items-center relative">
          <!-- 装饰性引号 -->
          <div class="absolute top-4 left-4 text-6xl text-dos-dim opacity-10 font-serif">“</div>
          <p class="text-dos-primary/90 leading-relaxed font-mono text-lg pl-6 relative z-10">
            > 身份验证通过。<br>
            > 正在执行指令：sudo rm -rf*。<br>
            > 这里是数字后花园，所有数据均已加密归档。"
          </p>
        </div>
      </div>
    </section>

    <!-- 2. 系统监控 -->
    <section>
      <SystemMonitor />
    </section>

    <!-- 3. 作品展示 (使用 ProjectGallery) -->
    <section>
      <div class="flex justify-between items-end mb-4 border-b-2 border-dos-dim pb-1">
        <h3 class="text-xl font-bold flex items-center gap-2">
          <span class="w-3 h-3 bg-dos-primary"></span> 作品归档 (PORTFOLIO)
        </h3>
        <span class="text-xs text-dos-dim font-mono">[DIR: /HOME/WORKS]</span>
      </div>
      <ProjectGallery />
    </section>

    <!-- 4. 博客文章 -->
    <section>
      <div class="flex justify-between items-end mb-4 border-b-2 border-dos-dim pb-1">
        <h3 class="text-xl font-bold flex items-center gap-2">
          <span class="w-3 h-3 bg-dos-primary"></span> Blog区
        </h3>
        <span class="text-xs text-dos-dim font-mono">/VAR/LOGS/</span>
      </div>

      <div class="glass-panel p-2">
        <table class="w-full text-left border-collapse">
          <thead class="bg-dos-primary/10 text-dos-primary text-xs uppercase">
            <tr>
              <th class="p-3 w-2/3">Filename</th>
              <th class="p-3 text-right">Modified</th>
            </tr>
          </thead>
          <tbody class="font-mono text-sm">
            {sortedPosts.map((post) => (
              <tr class="border-b border-dos-dim/30 hover:bg-dos-primary/10 transition-colors group cursor-pointer relative">
                <td class="p-3 pl-4">
                  <span class="absolute left-1 opacity-0 group-hover:opacity-100 text-dos-primary transition-opacity">></span>
                  <a href={`/posts/${post.slug}`} class="font-bold text-white group-hover:text-dos-primary block w-full truncate">
                     {post.slug}.TXT
                  </a>
                </td>
                <td class="p-3 text-right text-dos-dim">{post.data.date.toISOString().split('T')[0]}</td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </section>

    <!-- 5. 外部链接 -->
    <section id="contacts">
      <div class="flex justify-between items-end mb-4 border-b-2 border-dos-dim pb-1">
        <h3 class="text-xl font-bold flex items-center gap-2">
          <span class="w-3 h-3 bg-dos-primary"></span> 外链 (LINKS)
        </h3>
        <span class="text-xs text-dos-dim">NET_STATUS: CONNECTED</span>
      </div>
      <!-- 这里直接复用之前的 Grid 布局代码，保持不变即可，上面已有完整版 -->
       <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        {socialLinks.map(link => (
          <a href={link.url} target="_blank" class="glass-panel p-4 hover:bg-dos-primary hover:text-black transition-all group relative overflow-hidden no-underline h-28 flex flex-col justify-between hover:scale-[1.02] hover:shadow-[0_0_15px_rgba(51,255,0,0.3)]">
            <div class="absolute -right-2 -bottom-4 text-6xl opacity-5 font-black group-hover:opacity-10 pointer-events-none transition-opacity">↗</div>
            <div class="flex justify-between items-start z-10">
              <span class="font-bold text-lg tracking-tight">[{link.name}]</span>
              <span class="text-[9px] border border-current px-1 opacity-60 rounded-sm">{link.file}</span>
            </div>
            <div class="text-xs opacity-80 group-hover:opacity-100 font-mono z-10 flex items-center gap-1">
               <span class="w-1.5 h-1.5 bg-current rounded-full animate-pulse"></span> {link.desc}
            </div>
          </a>
        ))}
        {contacts.map(contact => (
          <div class="glass-panel p-4 bg-dos-dim/5 relative group h-28 flex flex-col justify-between cursor-help border-dashed hover:border-solid hover:border-dos-primary transition-all">
            <div class="flex justify-between items-start text-dos-dim group-hover:text-dos-primary">
              <span class="font-bold">[{contact.name}]</span>
              <span class="text-[9px] opacity-50 border border-current px-1">{contact.file}</span>
            </div>
            <div class="font-mono text-lg truncate select-all text-dos-primary group-hover:drop-shadow-[0_0_2px_rgba(51,255,0,0.8)]">
              {contact.value}
            </div>
            <div class="text-[10px] text-dos-dim uppercase flex justify-between border-t border-dos-dim/20 pt-2">
              <span>{contact.hint}</span>
              <span class="opacity-0 group-hover:opacity-100 font-bold">COPY ID</span>
            </div>
          </div>
        ))}
      </div>
    </section>

  </main>
  
  <TerminalFooter />
</BaseLayout>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
      const bars = document.querySelectorAll('.skill-bar');
      
      bars.forEach((el) => {
        // 修复 1: 告诉 TS 这个 el 是一个 HTMLElement，这样就有 style 属性了
        const bar = el as HTMLElement;

        // 修复 2: 安全地获取 style 属性
        const styleAttr = bar.getAttribute('style');
        
        // 修复 3: 只有当 style 属性存在时才进行正则匹配
        if (styleAttr) {
          const match = styleAttr.match(/--target-width:\s*([^;]+)/);
          
          // 修复 4: 只有当匹配成功(match 不为 null)时才设置宽度
          if (match && match[1]) {
            const target = match[1];
            bar.style.width = target;
            bar.style.transition = 'width 1.5s cubic-bezier(0.22, 1, 0.36, 1)';
          }
        }
      });
    }, 500);
  });
</script>